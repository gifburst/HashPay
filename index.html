<!DOCTYPE html>
<html>
<head>
	<title>MoggyCoin Wallet</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body>
	<div class="container mt-5">
		<div class="row">
			<div class="col-md-6">
				<h2>Scan MoggyCoin QR Code</h2>
				<div class="mb-3">
					<label for="scan-result" class="form-label">Scan Result:</label>
					<input type="text" class="form-control" id="scan-result" readonly>
				</div>
				<button type="button" class="btn btn-primary" onclick="scanQR()">Scan QR Code</button>
			</div>
			<div class="col-md-6">
				<h2>Saved MoggyCoin Codes</h2>
				<ul class="list-group" id="codes-list">
					<!-- Populated dynamically using JavaScript -->
				</ul>
			</div>
		</div>
	</div>

	<script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
<script>
    function scanQR() {
        let scanner = new Instascan.Scanner({ video: document.getElementById('preview'), scanPeriod: 5, mirror: false });
        scanner.addListener('scan', function (content) {
            let moggycoins = JSON.parse(localStorage.getItem('moggycoins')) || [];
            moggycoins.push(content);
            localStorage.setItem('moggycoins', JSON.stringify(moggycoins));
            scanner.stop();
            updateMoggyCoins();
        });
        Instascan.Camera.getCameras().then(function (cameras) {
            if (cameras.length > 0) {
                scanner.start(cameras[0]);
            } else {
                console.error('No cameras found.');
            }
        }).catch(function (e) {
            console.error(e);
        });
    }

    function updateMoggyCoins() {
        let moggycoins = JSON.parse(localStorage.getItem('moggycoins')) || [];
        let moggycoinsList = document.getElementById('moggycoins-list');
        moggycoinsList.innerHTML = '';
        if (moggycoins.length > 0) {
            for (let i = 0; i < moggycoins.length; i++) {
                let moggycoin = moggycoins[i];
                let moggycoinItem = document.createElement('div');
                moggycoinItem.className = 'mb-3';
                moggycoinItem.innerHTML = '<label class="form-label">MoggyCoin:</label>' +
                    '<div class="input-group">' +
                    '<input type="text" class="form-control" value="' + moggycoin + '" readonly>' +
                    '<button class="btn btn-outline-secondary" type="button" onclick="showQR(\'' + moggycoin + '\')">Show QR Code</button>' +
                    '</div>';
                moggycoinsList.appendChild(moggycoinItem);
            }
        } else {
            let noMoggyCoinsItem = document.createElement('div');
            noMoggyCoinsItem.className = 'mb-3';
            noMoggyCoinsItem.innerHTML = '<label class="form-label">MoggyCoins:</label>' +
                '<div class="alert alert-info" role="alert">No MoggyCoins saved.</div>';
            moggycoinsList.appendChild(noMoggyCoinsItem);
        }
    }

    function createQRCode(content) {
	// Create QR code
	let qrCode = new QRCode(document.getElementById('qrcode'), {
		text: content,
		width: 128,
		height: 128,
		colorDark : "#000000",
		colorLight : "#ffffff",
		correctLevel : QRCode.CorrectLevel.H
	});

	// Display countdown timer
	let countdownTimer = document.getElementById('countdown-timer');
	countdownTimer.innerText = '2:00';
	let timeRemaining = 2 * 60;

	// Set timer interval to update time remaining and delete QR code when time's up
	let timerInterval = setInterval(function() {
		timeRemaining--;
		let minutes = Math.floor(timeRemaining / 60);
		let seconds = timeRemaining % 60;
		let timeString = minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
		countdownTimer.innerText = timeString;

		if (timeRemaining <= 0) {
			qrCode.clear();
			localStorage.removeItem(content);
			countdownTimer.innerText = 'Code deleted';
			clearInterval(timerInterval);
		}
	}, 1000);
}

function displaySavedCodes() {
	let savedCodes = Object.keys(localStorage);
	let savedCodesList = document.getElementById('saved-codes-list');
	savedCodesList.innerHTML = '';

	if (savedCodes.length === 0) {
		savedCodesList.innerHTML = '<p>No saved codes</p>';
	}

	for (let i = 0; i < savedCodes.length; i++) {
		let savedCode = savedCodes[i];
		let codeElement = document.createElement('li');
		let codeLink = document.createElement('a');
		codeLink.href = '#';
		codeLink.innerText = savedCode;
		codeLink.addEventListener('click', function() {
			createQRCode(savedCode);
		});
		codeElement.appendChild(codeLink);
		savedCodesList.appendChild(codeElement);
	}
}

// Update saved codes list on page load
displaySavedCodes();
